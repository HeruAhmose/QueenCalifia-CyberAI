{{- /*
NetworkPolicies (optional).
Default behavior when enabled:
- restrict Ingress to same namespace + listed namespaces (e.g. ingress-nginx)
- do not restrict Egress unless networkPolicy.egress.allowAll=false
*/ -}}

{{- if .Values.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: qc-api
  namespace: {{ include "queen-califia.ns" . }}
  labels:
{{ include "queen-califia.labels" . | indent 4 }}
spec:
  podSelector:
    matchLabels:
      app: qc-api
      {{- include "queen-califia.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    {{- if not .Values.networkPolicy.egress.allowAll }}
    - Egress
    {{- end }}
  ingress:
    - from:
        {{- if .Values.networkPolicy.ingress.allowFromSameNamespace }}
        - podSelector: {}
        {{- end }}
        {{- range $ns := .Values.networkPolicy.ingress.allowFromNamespaces }}
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ $ns | quote }}
        {{- end }}
      ports:
        - protocol: TCP
          port: {{ .Values.api.service.port }}
  {{- if not .Values.networkPolicy.egress.allowAll }}
  egress:
    {{- if .Values.networkPolicy.egress.allowToSameNamespace }}
    - to:
        - podSelector: {}
    {{- end }}
    {{- if .Values.networkPolicy.egress.allowDNS }}
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: "kube-system"
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    {{- end }}
    {{- if .Values.redis.enabled }}
    - to:
        - podSelector:
            matchLabels:
              app: redis
              {{- include "queen-califia.selectorLabels" . | nindent 14 }}
      ports:
        - protocol: TCP
          port: 6379
    {{- end }}
    {{- range $cidr := .Values.networkPolicy.egress.allowToCIDRs }}
    - to:
        - ipBlock:
            cidr: {{ $cidr | quote }}
    {{- end }}
  {{- end }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: qc-frontend
  namespace: {{ include "queen-califia.ns" . }}
  labels:
{{ include "queen-califia.labels" . | indent 4 }}
spec:
  podSelector:
    matchLabels:
      app: qc-frontend
      {{- include "queen-califia.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    {{- if not .Values.networkPolicy.egress.allowAll }}
    - Egress
    {{- end }}
  ingress:
    - from:
        {{- if .Values.networkPolicy.ingress.allowFromSameNamespace }}
        - podSelector: {}
        {{- end }}
        {{- range $ns := .Values.networkPolicy.ingress.allowFromNamespaces }}
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ $ns | quote }}
        {{- end }}
      ports:
        - protocol: TCP
          port: {{ .Values.frontend.service.port }}
  {{- if not .Values.networkPolicy.egress.allowAll }}
  egress:
    {{- if .Values.networkPolicy.egress.allowToSameNamespace }}
    - to:
        - podSelector: {}
    {{- end }}
    {{- if .Values.networkPolicy.egress.allowDNS }}
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: "kube-system"
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    {{- end }}
    {{- range $cidr := .Values.networkPolicy.egress.allowToCIDRs }}
    - to:
        - ipBlock:
            cidr: {{ $cidr | quote }}
    {{- end }}
  {{- end }}
{{- end }}
